"use strict";var _slicedToArray=(function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i){break}}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"]){_i["return"]()}}finally{if(_d){throw _e}}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else{if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}})();angular.module("ui.mention",[]).directive("uiMention",function(){return{require:["ngModel","uiMention"],controller:"uiMention",controllerAs:"$mention",link:function link($scope,$element,$attrs,_ref){var _ref2=_slicedToArray(_ref,2);var ngModel=_ref2[0];var uiMention=_ref2[1];uiMention.init(ngModel)}}});"use strict";angular.module("ui.mention").controller("uiMention",["$element","$scope","$attrs","$q","$timeout","$document",function($element,$scope,$attrs,$q,$timeout,$document){var _this2=this;this.delimiter="@";this.searchPattern=this.pattern||new RegExp(this.delimiter+"(\\w+(?: \\w+)?)$");this.decodePattern=new RegExp(this.delimiter+"[[\\s\\w]+:[0-9a-z-]+]","gi");this.$element=$element;this.choices=[];this.mentions=[];var ngModel;this.init=function(model){var _this=this;$attrs.ngTrim="false";ngModel=model;ngModel.$parsers.push(function(value){_this.mentions=_this.mentions.filter(function(mention){if(~value.indexOf(_this.label(mention))){return value=value.replace(_this.label(mention),_this.encode(mention))}});_this.render(value);return value});ngModel.$formatters.push(function(){var value=arguments.length<=0||arguments[0]===undefined?"":arguments[0];value=value.toString();_this.mentions=_this.mentions.filter(function(mention){if(~value.indexOf(_this.encode(mention))){value=value.replace(_this.encode(mention),_this.label(mention));return true}else{return false}});return value});ngModel.$render=function(){$element.val(ngModel.$viewValue||"");$timeout(_this.autogrow,true);_this.render()}};var temp=document.createElement("span");function parseContentAsText(content){try{temp.textContent=content;return temp.innerHTML}finally{temp.textContent=null}}this.render=function(){var html=arguments.length<=0||arguments[0]===undefined?ngModel.$modelValue:arguments[0];html=(html||"").toString();html=parseContentAsText(html);_this2.mentions.forEach(function(mention){html=html.replace(_this2.encode(mention),_this2.highlight(mention))});_this2.renderElement().html(html);return html};this.renderElement=function(){return $element.next()};this.highlight=function(choice){return"<span>"+this.label(choice)+"</span>"};this.decode=function(){var value=arguments.length<=0||arguments[0]===undefined?ngModel.$modelValue:arguments[0];return value?value.replace(this.decodePattern,"$1"):""};this.label=function(choice){return choice.first+" "+choice.last};this.encode=function(choice){return'<a href="'+choice.id+'">'+this.label(choice)+"</a>"};this.replace=function(mention){var search=arguments.length<=1||arguments[1]===undefined?this.searching:arguments[1];var text=arguments.length<=2||arguments[2]===undefined?ngModel.$viewValue:arguments[2];text=text.substr(0,search.index+1)+this.label(mention)+" "+text.substr(search.index+search[0].length);return text};this.select=function(){var choice=arguments.length<=0||arguments[0]===undefined?this.activeChoice:arguments[0];if(!choice){return false}this.mentions.push(choice);ngModel.$setViewValue(this.replace(choice));this.cancel();ngModel.$render()};this.up=function(){var index=this.choices.indexOf(this.activeChoice);if(index>0){this.activeChoice=this.choices[index-1]}else{this.activeChoice=this.choices[this.choices.length-1]}};this.down=function(){var index=this.choices.indexOf(this.activeChoice);if(index<this.choices.length-1){this.activeChoice=this.choices[index+1]}else{this.activeChoice=this.choices[0]}};this.search=function(match){var _this3=this;this.searching=match;return $q.when(this.findChoices(match,this.mentions)).then(function(choices){_this3.choices=choices;_this3.activeChoice=choices[0];return choices})};this.findChoices=function(match,mentions){return[]};this.cancel=function(){this.choices=[];this.searching=null};this.autogrow=function(){$element[0].style.height=0;var style=getComputedStyle($element[0]);if(style.boxSizing=="border-box"){$element[0].style.height=$element[0].scrollHeight+"px"}};$element.on("keyup click focus",function(event){if(_this2.moved){return _this2.moved=false}if($element[0].selectionStart!=$element[0].selectionEnd){return}var text=$element.val();var match=_this2.searchPattern.exec(text.substr(0,$element[0].selectionStart));if(match){var copy=text.replace(/</g,"&lt;").replace(/>/g,"$gt;");copy=text.replace(/@/g,"<span>@</span>");$element.next().html(copy);var span=$element.next().find("span:last");var spanPos=span.position();_this2.search(match);if(!$scope.$$phase){$scope.$apply()}var ul=angular.element("mention-container").children(".dropdown");ul.css({top:spanPos.top+20,left:spanPos.left})}else{_this2.cancel()}});$element.on("keydown",function(event){if(!_this2.searching){return}switch(event.keyCode){case 13:_this2.select();break;case 38:_this2.up();break;case 40:_this2.down();break;default:return}_this2.moved=true;event.preventDefault();if(!$scope.$$phase){$scope.$apply()}});this.onMouseup=(function(event){var _this4=this;if(event.target==$element[0]){return}$document.off("mouseup",this.onMouseup);if(!this.searching){return}$scope.$evalAsync(function(){_this4.cancel()})}).bind(this);$element.on("focus",function(event){$document.on("mouseup",_this2.onMouseup)});$element.on("input",this.autogrow);$timeout(this.autogrow,true)}]);